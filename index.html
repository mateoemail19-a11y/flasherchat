<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flasher Messaging ⚡</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background-color: #111;
  color: white;
  font-family: sans-serif;
}
input, textarea, button {
  border-radius: 8px;
  outline: none;
}
input, textarea {
  background: #222;
  color: white;
  padding: 8px;
}
button {
  background: #4f46e5;
  color: white;
  padding: 8px 16px;
  margin: 4px;
  cursor: pointer;
}
button:hover {
  background: #6366f1;
}
#video {
  border-radius: 12px;
  max-height: 300px;
  width: 100%;
}
#lightIndicator {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #ff0000;
  margin-top: 10px;
  box-shadow: 0 0 20px #ff0000;
  transition: background 0.2s, box-shadow 0.2s;
}
#chatWindow {
  background: #222;
  padding: 8px;
  border-radius: 12px;
  height: 200px;
  overflow-y: auto;
}
#syncStatus {
  margin-top: 6px;
  font-size: 0.9rem;
  color: #aaa;
}
</style>
</head>
<body class="p-4">

<h1 class="text-2xl font-bold mb-4">Flasher Messaging ⚡</h1>

<!-- User name input -->
<div class="mb-4">
  <label>Your Name:</label>
  <input id="userName" placeholder="Enter your name" />
</div>

<!-- Chat window -->
<div id="chatWindow" class="mb-4"></div>

<!-- Sync private chat -->
<div class="mb-4">
  <button id="toggleSync">Enable Private Sync</button>
  <div id="syncStatus">Not synced</div>
</div>

<!-- Message input -->
<div class="mb-4">
  <textarea id="flashMessage" placeholder="Type a message..."></textarea>
  <button onclick="sendFlashMessage()">Send Flash</button>
</div>

<!-- Camera preview and light detection -->
<video id="video" autoplay playsinline></video>
<div id="lightIndicator"></div>
<p>Tap the video to select flash detection area</p>

<script>
let stream, track;
let receiveActive = false;
let sending = false;
let privateSync = false;
let sessionCode = Math.random().toString(36).substring(2, 10);
let roi = null; // region of interest
let lastBrightness = 0;
let flashStart = null;
let flashBuffer = "";
const chatWindow = document.getElementById('chatWindow');
const indicator = document.getElementById('lightIndicator');
const syncStatus = document.getElementById('syncStatus');

const getUserName = () => document.getElementById('userName').value || "You";

document.getElementById('toggleSync').onclick = () => {
  privateSync = !privateSync;
  syncStatus.innerText = privateSync ? `Synced. Communicating with hidden session.` : "Not synced";
};

document.getElementById('video').onclick = (e) => {
  const rect = e.target.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;
  roi = { x, y, width: 0.2, height: 0.2 }; // 20% region
  alert("Detection area set!");
};

async function initCamera() {
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  const video = document.getElementById('video');
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
}

function appendMessage(sender, text) {
  const div = document.createElement('div');
  div.innerHTML = `<strong>${sender}:</strong> ${text}`;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function sendFlashMessage() {
  if (sending) return alert("Already sending");
  sending = true;
  const msg = document.getElementById('flashMessage').value.trim();
  if (!msg) return alert("Enter a message");

  if (!track) await initCamera();
  const caps = track.getCapabilities();
  if (!caps.torch) return alert("Torch not supported");

  const binary = msg.split("").map(c => c.charCodeAt(0).toString(2).padStart(8,'0')).join("");
  let i = 0;

  function nextBit() {
    if (i >= binary.length) {
      track.applyConstraints({ advanced: [{ torch: false }] });
      sending = false;
      return;
    }
    const on = binary[i] === "1";
    track.applyConstraints({ advanced: [{ torch: on }] });
    i++;
    setTimeout(nextBit, 150);
  }
  nextBit();
  appendMessage(getUserName(), msg);
}

async function startReceiving() {
  if (!stream) await initCamera();
  receiveActive = true;
  const video = document.getElementById('video');
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  function readFrame() {
    if (!receiveActive) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    let xStart = 0, yStart = 0, w = canvas.width, h = canvas.height;
    if (roi) {
      xStart = roi.x * canvas.width;
      yStart = roi.y * canvas.height;
      w = roi.width * canvas.width;
      h = roi.height * canvas.height;
    }

    const frame = ctx.getImageData(xStart, yStart, w, h).data;
    let brightness = 0;
    for (let i = 0; i < frame.length; i += 4) {
      brightness += (frame[i] + frame[i+1] + frame[i+2])/3;
    }
    brightness /= (frame.length / 4);

    if (brightness > 180 && lastBrightness <= 180) {
      flashStart = performance.now();
    }
    if (brightness <= 180 && lastBrightness > 180 && flashStart) {
      const duration = performance.now() - flashStart;
      flashBuffer += duration < 200 ? "." : "-";
      if (flashBuffer.length >= 8) {
        const charCode = parseInt(flashBuffer, 2);
        if (!isNaN(charCode)) {
          let sender = privateSync ? "Private" : "Unknown";
          appendMessage(sender, String.fromCharCode(charCode));
        }
        flashBuffer = "";
      }
      flashStart = null;
    }

    lastBrightness = brightness;

    indicator.style.background = brightness > 180 ? '#00ff00' : '#ff0000';
    indicator.style.boxShadow = brightness > 180 ? '0 0 30px #00ff00' : '0 0 20px #ff0000';

    requestAnimationFrame(readFrame);
  }
  readFrame();
}

// Auto-start receiving
startReceiving();
</script>
</body>
</html>
