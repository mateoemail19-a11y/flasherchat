<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flasher Messaging ⚡ - Ultra Secure Communication</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
function toggleTheme() {
  document.documentElement.classList.toggle("dark");
}
</script>

<style>
input, textarea {
  background: white !important;
  color: black !important;
  caret-color: black !important;
}
.dark input, .dark textarea {
  background: #111 !important;
  color: white !important;
  caret-color: white !important;
}
#lightIndicator {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #ff0000;
  box-shadow: 0 0 20px #ff0000;
  transition: background 0.1s, box-shadow 0.1s;
  position: relative;
  overflow: hidden;
}
</style>
</head>

<body class="bg-gray-900 dark:bg-gray-100 text-white dark:text-black min-h-screen flex flex-col items-center p-6 transition-all font-sans">

<div class="w-full max-w-2xl flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold">Flasher Messaging ⚡</h1>
  <button onclick="toggleTheme()" class="px-4 py-2 bg-yellow-500 rounded shadow hover:bg-yellow-600 transition">Toggle Theme</button>
</div>
<p class="text-center text-lg opacity-80 mb-6">The securest form of digital communication</p>

<!-- Communication ID -->
<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <label class="block mb-2 text-sm">Communication ID</label>
  <div class="flex gap-2">
    <input id="commId" type="text" placeholder="Enter or generate one..." class="flex-1 p-2 rounded">
    <button onclick="generateSecureID()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Generate</button>
  </div>
</div>

<!-- Message to flash -->
<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <label class="block mb-2 text-sm">Message to Flash</label>
  <textarea id="flashMessage" placeholder="Type message..." class="w-full h-24 p-2 rounded"></textarea>
  <button onclick="sendFlashMessage()" class="w-full mt-3 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition">Send Flash Signal</button>
</div>

<!-- Receive Mode -->
<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <h2 class="font-bold mb-2">Receive Mode</h2>
  <p class="text-sm mb-2 opacity-80">Point your camera at the flashing phone and enter the Communication ID.</p>
  <div class="flex gap-2 mb-3">
    <input id="receiveId" type="text" placeholder="Enter Communication ID to listen for" class="flex-1 p-2 rounded">
    <button onclick="startReceive()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition">Start</button>
  </div>
  <div id="receivedOutput" class="p-3 bg-black dark:bg-white text-green-400 dark:text-purple-700 rounded h-24 overflow-y-auto"></div>
</div>

<!-- Camera Preview + Light Detector -->
<div class="w-full max-w-2xl flex flex-col items-center mb-6">
  <video id="video" autoplay playsinline class="w-full rounded-xl shadow-lg"></video>
  <div id="lightIndicator" class="mt-3"></div>
  <p class="mt-2 text-sm text-center opacity-70">Light detector shows green when flash is detected</p>
</div>

<script>
let stream, track;
let receiveActive = false;
let binaryBuffer = "";
let lastLight = 0;

function generateSecureID() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  const length = Math.floor(Math.random() * 5) + 6;
  let result = "";
  for (let i = 0; i < length; i++) result += chars[Math.floor(Math.random() * chars.length)];
  document.getElementById("commId").value = result;
}

async function initCamera() {
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  const video = document.getElementById("video");
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
}

// Send flashes
async function sendFlashMessage() {
  const msg = document.getElementById("flashMessage").value.trim();
  if (!msg) return alert("Enter a message first");
  if (!track) await initCamera();

  const caps = track.getCapabilities();
  if (!caps.torch) return alert("Torch not supported on this device.");

  let i = 0;
  function nextChar() {
    if (i >= msg.length) return track.applyConstraints({ advanced: [{ torch: false }] });
    const binary = msg[i].charCodeAt(0).toString(2).padStart(8, "0");
    let b = 0;

    function nextBit() {
      if (b >= binary.length) {
        track.applyConstraints({ advanced: [{ torch: false }] });
        return setTimeout(() => { i++; nextChar(); }, 250);
      }
      track.applyConstraints({ advanced: [{ torch: binary[b] === "1" }] });
      b++;
      setTimeout(nextBit, 150);
    }
    nextBit();
  }
  nextChar();
}

// Enhanced receive mode
async function startReceive() {
  if (!stream) await initCamera();
  receiveActive = true;
  const video = document.getElementById("video");
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const indicator = document.getElementById("lightIndicator");

  let brightnessHistory = [];
  const historyLength = 5; // smoothing

  function readFrame() {
    if (!receiveActive) return;

    const w = 100, h = 100; // central sample region
    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(video, video.videoWidth/2 - w/2, video.videoHeight/2 - h/2, w, h, 0, 0, w, h);
    const frame = ctx.getImageData(0, 0, w, h).data;

    let brightness = 0;
    for (let i = 0; i < frame.length; i += 4)
      brightness += 0.299*frame[i] + 0.587*frame[i+1] + 0.114*frame[i+2];
    brightness /= frame.length/4;

    brightnessHistory.push(brightness);
    if (brightnessHistory.length > historyLength) brightnessHistory.shift();
    const avg = brightnessHistory.reduce((a,b)=>a+b,0)/brightnessHistory.length;

    const flashDetected = brightness - avg > 40; // sudden spike
    const bit = flashDetected ? 1 : 0;

    if (bit !== lastLight) {
      binaryBuffer += bit;
      if (binaryBuffer.length === 8) {
        const char = String.fromCharCode(parseInt(binaryBuffer, 2));
        document.getElementById("receivedOutput").innerText += char;
        binaryBuffer = "";
      }
      lastLight = bit;
    }

    // glowing indicator
    indicator.style.background = flashDetected ? '#00ff00' : '#ff0000';
    indicator.style.boxShadow = flashDetected ? '0 0 40px #00ff00' : '0 0 20px #ff0000';

    requestAnimationFrame(readFrame);
  }

  readFrame();
}
</script>

</body>
</html>
