<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flasher Messaging ⚡ - Offline Robust Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: sans-serif; transition: background 0.3s, color 0.3s; }
textarea { background: white !important; color: black !important; caret-color: black !important; }
.dark textarea { background: #111 !important; color: white !important; caret-color: white !important; }
#lightIndicator {
  width: 60px; height: 60px; border-radius: 50%;
  background: #ff0000; box-shadow: 0 0 20px #ff0000;
  transition: background 0.2s, box-shadow 0.2s;
}
</style>
</head>
<body class="bg-gray-900 dark:bg-gray-100 text-white dark:text-black min-h-screen flex flex-col items-center p-6">

<div class="w-full max-w-2xl flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold">Flasher Messaging ⚡</h1>
</div>
<p class="text-center text-lg opacity-80 mb-6">Offline Robust Mode: Works under any light and device</p>

<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <label class="block mb-2 text-sm">Message to Flash</label>
  <textarea id="flashMessage" placeholder="Type message..." class="w-full h-24 p-2 rounded"></textarea>
  <button onclick="sendFlashMessage()" class="w-full mt-3 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition">Send Flash Signal</button>
</div>

<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <h2 class="font-bold mb-2">Receive Mode</h2>
  <p class="text-sm mb-2 opacity-80">Point your camera at the flashing phone. Works with any device.</p>
  <button onclick="startReceive()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition">Start Receiving</button>
  <div id="receivedOutput" class="p-3 bg-black dark:bg-white text-green-400 dark:text-purple-700 rounded h-24 overflow-y-auto mt-3"></div>
</div>

<div class="w-full max-w-2xl flex flex-col items-center mb-6">
  <video id="video" autoplay playsinline class="w-full rounded-xl shadow-lg"></video>
  <div id="lightIndicator" class="mt-3"></div>
  <p class="mt-2 text-sm text-center opacity-70">Green when flash detected</p>
</div>

<script>
let stream;
let lastBitTime = 0;
let binaryBuffer = "";
const fixedCode = "10101011"; // offline preamble
const bitDuration = 150; // ms

async function initCamera() {
  if(stream) return;
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  document.getElementById("video").srcObject = stream;
}

// Flash sending
async function sendFlashMessage() {
  const msg = document.getElementById("flashMessage").value.trim();
  if(!msg) return alert("Enter a message first");
  await initCamera();

  const track = stream.getVideoTracks()[0];
  const caps = track.getCapabilities();
  if(!caps.torch) return alert("Torch not supported.");

  const fullMsg = fixedCode + [...msg].map(c=>c.charCodeAt(0).toString(2).padStart(8,'0')).join("");
  let i = 0;
  function nextBit() {
    if(i>=fullMsg.length) return track.applyConstraints({ advanced: [{ torch:false }] });
    track.applyConstraints({ advanced:[{torch:fullMsg[i]==='1'}]});
    i++;
    setTimeout(nextBit, bitDuration);
  }
  nextBit();
}

// Robust light detection
async function startReceive() {
  await initCamera();
  const video = document.getElementById("video");
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const indicator = document.getElementById("lightIndicator");
  let state="searchPreamble";
  let bitWindow=[];
  let ambientBrightness=0;
  let lastBit="0";

  function readFrame(){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);
    const frame = ctx.getImageData(0,0,canvas.width,canvas.height).data;

    // central 20% region
    const startX=canvas.width*0.4|0, endX=canvas.width*0.6|0;
    const startY=canvas.height*0.4|0, endY=canvas.height*0.6|0;
    let brightnessSum=0, count=0;
    for(let y=startY;y<endY;y++){
      for(let x=startX;x<endX;x++){
        const idx=(y*canvas.width+x)*4;
        brightnessSum += frame[idx]+frame[idx+1]+frame[idx+2];
        count++;
      }
    }
    let brightness = brightnessSum/(count*3);

    // update ambient brightness (slow moving average)
    ambientBrightness = ambientBrightness*0.9 + brightness*0.1;

    // adaptive threshold
    const threshold = ambientBrightness*1.3; // slightly above ambient
    const bit = brightness>threshold ? "1":"0";

    // smooth last 5 frames
    bitWindow.push(bit);
    if(bitWindow.length>5) bitWindow.shift();
    const majority = bitWindow.filter(b=>b==="1").length>2?"1":"0";

    const now = performance.now();
    if(now - lastBitTime > bitDuration*0.8 && majority!==lastBit){
      lastBitTime=now;
      lastBit=majority;

      // update indicator
      indicator.style.background=majority==="1"?"#00ff00":"#ff0000";
      indicator.style.boxShadow=majority==="1"?"0 0 30px #00ff00":"0 0 20px #ff0000";

      binaryBuffer+=majority;

      if(state==="searchPreamble"){
        if(binaryBuffer.endsWith(fixedCode)){
          state="receiveMessage";
          binaryBuffer="";
        } else if(binaryBuffer.length>fixedCode.length*2){
          binaryBuffer=binaryBuffer.slice(-fixedCode.length);
        }
      } else if(state==="receiveMessage"){
        if(binaryBuffer.length===8){
          const char=String.fromCharCode(parseInt(binaryBuffer,2));
          document.getElementById("receivedOutput").innerText+=char;
          binaryBuffer="";
        }
      }
    }

    requestAnimationFrame(readFrame);
  }
  readFrame();
}
</script>
</body>
</html>
