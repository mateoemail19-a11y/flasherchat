<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flasher Messaging ⚡ - Private Flash Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#111; color:#fff; font-family:sans-serif; }
input, textarea, button { font-size:1rem; }
.button { padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer; font-weight:bold; transition:0.2s; }
.button:hover { opacity:0.9; }
#videoContainer { position: relative; width:100%; max-width:500px; }
#video { width:100%; border-radius:0.75rem; }
#selectionBox { position:absolute; border:3px solid #00ff00; pointer-events:none; border-radius:0.5rem; }
#lightIndicator { width:50px; height:50px; border-radius:50%; background:#ff0000; box-shadow:0 0 20px #ff0000; margin-top:0.5rem; }
</style>
</head>
<body class="flex flex-col items-center p-4 gap-4">

<h1 class="text-3xl font-bold mb-2">Flasher Messaging ⚡</h1>
<p class="opacity-80 mb-4 text-center">Ultra secure private Morse-based flash chat</p>

<div class="w-full max-w-md flex flex-col gap-2">
  <label>Username:</label>
  <input id="username" type="text" placeholder="Enter your name" class="p-2 rounded text-black">
</div>

<div class="w-full max-w-md flex flex-col gap-2">
  <label>Message:</label>
  <textarea id="flashMessage" placeholder="Type message..." class="p-2 rounded text-black h-24"></textarea>
  <button onclick="sendFlashMessage()" class="button bg-green-600 text-white">Send Flash Signal</button>
</div>

<div class="w-full max-w-md flex flex-col gap-2">
  <button onclick="togglePrivateSync()" class="button bg-blue-600 text-white">Toggle Private Sync</button>
  <div id="syncStatus" class="text-green-400 mt-1">Not synced</div>
</div>

<div class="w-full max-w-md flex flex-col items-center gap-2">
  <div id="lightIndicator"></div>
</div>

<div id="videoContainer">
  <video id="video" autoplay playsinline></video>
  <div id="selectionBox"></div>
</div>

<div class="w-full max-w-md flex flex-col gap-2 mt-2">
  <h2 class="font-bold">Received Messages:</h2>
  <div id="receivedOutput" class="p-2 bg-black rounded h-32 overflow-auto text-green-400"></div>
</div>

<script>
let stream, track;
let privateSync = false;
let sessionCode = ""; // hidden session for private chat
let syncedDeviceName = "";
let isSelecting = false;
let selection = {x:0, y:0, w:0, h:0};
let morseBuffer = "";
let lastBrightness = 0;
let lastFlashTime = 0;
let lastGapTime = performance.now();
const dotDashThreshold = 200;
const letterGapThreshold = 400;
const wordGapThreshold = 1000;
const video = document.getElementById("video");
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");
const indicator = document.getElementById("lightIndicator");
const selectionBox = document.getElementById("selectionBox");
const output = document.getElementById("receivedOutput");

const morseStandard = {
  ".-":"A","-...":"B","-.-.":"C","-..":"D",".":"E",
  "..-.":"F","--.":"G","....":"H","..":"I",".---":"J",
  "-.-":"K",".-..":"L","--":"M","-.":"N","---":"O",
  ".--.":"P","--.-":"Q",".-.":"R","...":"S","-":"T",
  "..-":"U","...-":"V",".--":"W","-..-":"X","-.--":"Y","--..":"Z",
  "-----":"0",".----":"1","..---":"2","...--":"3","....-":"4",".....":"5",
  "-....":"6","--...":"7","---..":"8","----.":"9"," ":" "
};

let morseMap = {...morseStandard};

function togglePrivateSync(){
  privateSync = !privateSync;
  if(privateSync){
    // Generate hidden session code
    sessionCode = Math.random().toString(36).substring(2,10);
    // Shuffle morse map
    const keys = Object.keys(morseStandard);
    const values = Object.values(morseStandard).sort(()=>Math.random()-0.5);
    morseMap = {};
    keys.forEach((k,i)=>morseMap[k]=values[i]);
    syncedDeviceName = prompt("Enter the name of the device you are syncing with:") || "Unknown";
    document.getElementById("syncStatus").innerText = `Private Sync ON with "${syncedDeviceName}"`;
  } else {
    sessionCode="";
    syncedDeviceName="";
    morseMap = {...morseStandard};
    document.getElementById("syncStatus").innerText = "Private Sync OFF";
  }
}

async function initCamera(){
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
}

// Selection box events
video.addEventListener("mousedown",(e)=>{
  const rect=video.getBoundingClientRect();
  selection.x=e.clientX-rect.left;
  selection.y=e.clientY-rect.top;
  isSelecting=true;
});
video.addEventListener("mousemove",(e)=>{
  if(!isSelecting) return;
  const rect=video.getBoundingClientRect();
  selection.w=(e.clientX-rect.left)-selection.x;
  selection.h=(e.clientY-rect.top)-selection.y;
  selectionBox.style.left=selection.x+"px";
  selectionBox.style.top=selection.y+"px";
  selectionBox.style.width=selection.w+"px";
  selectionBox.style.height=selection.h+"px";
});
video.addEventListener("mouseup",(e)=>{isSelecting=false;});

function sendFlashMessage(){
  if(!track)initCamera();
  const msg = document.getElementById("flashMessage").value.trim();
  if(!msg) return alert("Enter a message");
  const caps = track.getCapabilities();
  if(!caps.torch) return alert("Torch not supported");
  let i=0;
  function nextChar(){
    if(i>=msg.length){track.applyConstraints({advanced:[{torch:false}]}); return;}
    const binary=msg[i].charCodeAt(0).toString(2).padStart(8,"0");
    let b=0;
    function nextBit(){
      if(b>=binary.length){track.applyConstraints({advanced:[{torch:false}]}); return setTimeout(()=>{i++;nextChar();},250);}
      track.applyConstraints({advanced:[{torch:binary[b]==="1"}]});
      b++; setTimeout(nextBit,150);
    }
    nextBit();
  }
  nextChar();
}

function processFrame(){
  const rect=video.getBoundingClientRect();
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  
  const x = selection.w?Math.floor(selection.x*canvas.width/rect.width):0;
  const y = selection.h?Math.floor(selection.y*canvas.height/rect.height):0;
  const w = selection.w?Math.floor(selection.w*canvas.width/rect.width):canvas.width;
  const h = selection.h?Math.floor(selection.h*canvas.height/rect.height):canvas.height;

  const frame = ctx.getImageData(x,y,w,h).data;
  let brightness = 0;
  for(let i=0;i<frame.length;i+=4) brightness+=(frame[i]+frame[i+1]+frame[i+2])/3;
  brightness/=frame.length/4;

  const now = performance.now();
  const delta = now - lastGapTime;

  const ambientThreshold = lastBrightness + 30;
  let flashDetected = brightness>ambientThreshold;

  indicator.style.background=flashDetected?"#00ff00":"#ff0000";
  indicator.style.boxShadow=flashDetected?"0 0 30px #00ff00":"0 0 20px #ff0000";

  if(flashDetected){
    if(!lastFlashTime) lastFlashTime=now;
  } else {
    if(lastFlashTime){
      const duration=now-lastFlashTime;
      morseBuffer+=(duration<dotDashThreshold?".":"-");
      lastFlashTime=null;
      lastGapTime=now;
    }
  }

  if(morseBuffer && delta>letterGapThreshold){
    const letter = Object.keys(morseMap).find(k=>morseMap[k]===morseBuffer)||"?";
    const namePrefix = privateSync?`[${syncedDeviceName}] `:"";
    output.innerText+=namePrefix+letter;
    morseBuffer="";
  }

  if(delta>wordGapThreshold) output.innerText+=" ";

  lastBrightness=brightness;
  requestAnimationFrame(processFrame);
}

initCamera();
requestAnimationFrame(processFrame);
</script>
</body>
</html>
